name: Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

env:
  PUBLISH_DIR: public
  NODE_OPTIONS: --max-old-space-size=4096

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: build-and-deploy-${{ github.workflow }}-${{ github.ref_name }}
      cancel-in-progress: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Cache npm cache
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: |
            ~/.npm
            ~/.cache
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: |
          npm ci --prefer-offline --no-audit --progress=false

      - name: Build site
        run: |
          npm run build

      - name: Ensure publish directory exists & verify build output
        run: |
          mkdir -p "${{ env.PUBLISH_DIR }}"
          
          if [ -z "$(ls -A "${{ env.PUBLISH_DIR }}" 2>/dev/null || true)" ]; then
            echo "Error: '${{ env.PUBLISH_DIR }}' is empty after build."
            echo "Contents of repository root for debugging:"
            ls -la
            exit 1
          fi
          echo "Publish directory contains:"
          ls -la "${{ env.PUBLISH_DIR }}"

      - name: Disable Jekyll and write CNAME
        run: |
          
          touch "${{ env.PUBLISH_DIR }}/.nojekyll"

          if [ -n "${{ env.CUSTOM_DOMAIN:- }}" ]; then
            echo "${{ env.CUSTOM_DOMAIN }}" > "${{ env.PUBLISH_DIR }}/CNAME"
            echo "Wrote CNAME: ${{ env.CUSTOM_DOMAIN }}"
          fi

      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v1
        with:
          path: ${{ env.PUBLISH_DIR }}

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v1

      - name: List deployed files (for debugging)
        if: ${{ always() }}
        run: |
          echo "Contents of publish directory (for workflow log):"
          ls -la "${{ env.PUBLISH_DIR }}" || true

      - name: Print published message
        if: ${{ always() }}
        run: |
          echo "Published directory: ${{ env.PUBLISH_DIR }}"