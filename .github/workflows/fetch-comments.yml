name: Fetch Comments

on:
  schedule:
    - cron: '0 */6 * * *'   

permissions:
  contents: write

jobs:
  fetch-comments:
    if: ${{ github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest

    concurrency:
      group: fetch-comments-${{ github.ref }}
      cancel-in-progress: false

    env:
      COMMENTS_OUTPUT: ./data/comments.json

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Validate output directory
        shell: bash
        run: |
          mkdir -p "$(dirname "$COMMENTS_OUTPUT")"

      - name: Fetch comments
        shell: bash
        env:
          COMMENTS_APP_ID: ${{ secrets.COMMENTS_APP_ID }}
          COMMENTS_APP_SECRET: ${{ secrets.COMMENTS_APP_SECRET }}
        run: |
          set -euo pipefail
          TMP="$RUNNER_TEMP/comments.json.tmp"
          rm -f "$TMP"

          if [ -z "${COMMENTS_APP_ID:-}" ]; then
            echo "ERROR: COMMENTS_APP_ID secret missing"; exit 3
          fi
          if [ -z "${COMMENTS_APP_SECRET:-}" ]; then
            echo "ERROR: COMMENTS_APP_SECRET secret missing"; exit 4
          fi

          URL="https://script.google.com/macros/s/${COMMENTS_APP_ID}/exec?secret=${COMMENTS_APP_SECRET}"

          curl -fsSL --max-time 30 --retry 3 --retry-delay 2 "$URL" -o "$TMP"

          if head -c 256 "$TMP" | grep -qi '<html\|<!doctype'; then
            echo "ERROR: HTML detected (redirect/login)."
            exit 6
          fi

          if command -v python3 >/dev/null 2>&1; then
            python3 -m json.tool "$TMP" >/dev/null 2>&1 || { echo "ERROR: Invalid JSON."; exit 7; }
          fi


          if [ -f "$COMMENTS_OUTPUT" ]; then
            if cmp -s "$TMP" "$COMMENTS_OUTPUT"; then
              echo "No content changes detected. Not writing or committing."
              exit 0      
            fi
          fi

          echo "Content changed. Replacing comments.json."
          mv "$TMP" "$COMMENTS_OUTPUT"

      - name: Commit and push (only if file changed)
        if: ${{ success() }}
        shell: bash
        run: |
          set -euo pipefail
          OUT="$COMMENTS_OUTPUT"

          if [ ! -f "$OUT" ]; then
            echo "Output file missing; skipping commit."
            exit 0
          fi

          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add "$OUT"

          if git diff --cached --quiet; then
            echo "No staged changes; skipping commit."
            exit 0
          fi

          git commit -m "updated comments."
          git push origin HEAD
